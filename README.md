# KoopmanCVAE 轨道动力学预测模型

<u>*（较KoopmanVAE修改的地方用斜体下划线表示）*</u>

本项目实现了一个基于 Koopman 算子理论和<u>*条件变分自编码器 (CVAE)*</u> 的深度学习模型，用于对非线性轨道动力学系统进行建模和长时程预测。

## 1. 项目简介

Koopman 算子理论指出，非线性动力学系统可以通过一个无限维的线性算子在观测函数空间中进行描述。本项目利用深度神经网络来近似这个有限维的 Koopman 不变子空间。

模型核心思想是将低维非线性状态空间（轨道六根数/状态量）映射到一个高维潜在空间（观测空间），在该空间中系统的演化近似为线性的，然后再映射回原始状态空间。

## 2. 模型架构 (KoopmanVAE)

*<u>模型定义在 `model3.py` 中，主要包含以下组件：</u>*

1.  **编码器 (Encoder F)**: $X \to \Psi$
    -   将原始状态 $x$ (6维：位置+速度) 映射到高维观测空间 $\Psi$ (64维)。
    -   由多层全连接神经网络构成。

2.  *<u>**算子推理网络 (Operator Inference)**: $[\Psi_i,\Psi_{i+1},\Delta_i] \to z$</u>*
    -   根据*<u>当前观测状态$\Psi_{i+1}$、及其初始状态对应的观测状态$\Psi_i$、初始与当前时间间隔$\Delta_i$</u>*：推断 Koopman 算子的潜在分布参数 ($\mu, \log\sigma^2$)。
    -   引入 *<u>CVAE</u>* 结构，使模型具有生成能力和更好的鲁棒性。

3.  **算子生成器 (Operator Generator)**: $z \to K$
    -   从潜在变量 $z$ 生成具体的 Koopman 演化矩阵 $K$。
    -   *<u>潜在变量z对应的标签为其初始状态$x_i$、初始与当前时间间隔$\Delta_i$，生成时可以通过标签直接获得对应z进行后续计算：对应实际情况：给定初始状态和演化时间给出对应的当前状态</u>*
    -   *<u>注意！用loss约定了同文件的z尽可能接近，生成器用于获取对应时间间隔的K，不同的时间间隔K不同。（适用于非均匀时间间隔）</u>*

4.  **线性演化 (Linear Evolution)**: $\Psi_{i+1} = K \cdot \Psi_i$
    -   在观测空间中执行线性预测。

5.  **解码器 (Decoder F')**: $\Psi \to X$
    -   将预测后的观测状态 $\Psi_{i+1}$ 映射回原始状态空间 $x_{i+1}$。

> [!CAUTION]
>
> 训练数据与之前不同，不对文件中的数据做序列划分，而是随机选取状态对$[\Psi_i,\Psi_{i+1},\Delta_i]$用于训练，适应非均匀时间间隔

## 3. 环境要求

请确保安装以下 Python 库：

```bash
pip install torch numpy matplotlib pandas tqdm
```

## 4. 文件结构

```
.
├── data/               # 存放训练轨道数据文件 (.txt)
├── results/            # 存放训练模型和预测结果
├── dataset3.py          # 数据加载与预处理（归一化（只对状态归一化，对时间不做归一化））
├── model3.py            # KoopmanCVAE 模型定义
├── train3.py            # 模型训练脚本
└── README_CVAE.md       # 项目说明文档
```

## 5. 使用方法

### 5.1 数据准备

将训练轨道数据文件（`.txt` 格式）放置在 `data/` 目录下。

- 数据格式应为多列文本，第 2-7 列为轨道状态量 (x, y, z, vx, vy, vz)。
- 程序会自动读取 `data/` 目录下的所有 txt 文件进行训练。

*<u>将测试数据文件放在`data/` 目录外，数据格式同上</u>*

### 5.2 训练模型

运行 `train.py` 开始训练：

```bash
python train3.py
```

- 程序会自动加载数据，进行归一化处理。
- 训练过程中会显示进度条和损失值。
- 训练完成后，模型将保存为 `results/koopman_model.pth`。

### 5.3 测试还没写😭

运行 `test.py` 进行模型评估和长时程预测：

```bash
python test.py
```

**可选参数：**

- `--model_path`: 指定模型路径 (默认: `results/koopman_model.pth`)
- `--data_file`: 指定测试数据文件 (默认: 自动选择 `data/` 下排序后的最后一个文件)
- `--start_idx`: 预测起始索引 (默认: -1，即从验证集开始)
- `--steps`: 预测步数 (默认: 500)

**示例：**

```bash
python test.py --steps 1000
```

### 5.4 结果查看

- **训练模型**: `results/koopman_cvae_unified_model_final.pth`
- **预测可视化**: `results/unified_prediction_result_？.png` (包含真实轨迹与预测轨迹的对比图，？是训练次数)

## 6. 补充说明

- **数据归一化**: `dataset.py` 中实现了 `SimpleScaler`，将大幅度的轨道数据归一化到标准正态分布附近，这对神经网络训练至关重要。
- *<u>**单步预测**: 训练时采用了没有采用常规的多步损失函数，因为$\Delta_i$可以是任意的时间间隔，不是一般意义上的“单步”；且预测的时候不会进行单步-单步-单步预测，而是直接调整$\Delta_i$进行一次单步预测。</u>*

